本系统采用C/S（客户端/服务器）模式，实现了登录注册、重置密码、收发消息、好友搜索、好友推荐、好友申请和好友验证等基本功能。为了确保分布式架构下各服务的数据一致性，系统设计中引入了Redis的原子操作机制，所有用户状态通过Redis同一管理。同时通过任务队列的方式存储具体的操作逻辑，部分关键操作引入锁和条件变量独占资源，防止读写冲突。

本系统各板块的通信机制分为两类：基于asio实现的TCP可靠长链接异步通信和基于gRPC的服务器间通信。Boost.Asio 在异步读写时，使用 shared_from_this()进行指针生命周期管理，保证对象在异步操作期间不会析构，如果连接中断，会触发延迟重连机制，通过 async_read 的回调中检测 ec 错误码异步方式处理断线，循环尝试直到成功。gRPC 拥有连接状态监控机制，使用 Channel::GetState 检查连接状态，并实现重连机制。同时，配合 gRPC 自带的 KeepAlive 和 Backoff 配置参数，实现连接断开的自动恢复，确保服务器通信时临时不可用的情况下能够持续尝试连接并自动恢复通信。这些通信协议和各程序板块组成了本系统设计，其中登录操作是本系统中最为重要的一部分操作。下图详细的说明了登陆时各模块之间的连接建立和信息交互。

登录时客户端向网关服务器发送HTTP请求，网关服务器查询数据库后通过gRPC将分配聊天服务器的操作分配给状态服务器，状态服务器将负载均衡最小的服务器返回给客户端并设置token（登录令牌），然后由客户端向对应的聊天服务器建立可靠的TCP长连接。注册和重置密码时，需要接收邮箱验证码，客户端同样发送HTTP请求到网关服务器，网关服务器通过gPRC转发操作到验证服务器，由验证服务器的nodemailer板块将验证码发送到对应邮箱中并将验证码写入redis缓存以供网关服务器验证。

![连接建立机制](./image/image-1.png)

在建立TCP长连接后，一些操作比如好友搜索，获取推荐列表、好友列表，收发消息和添加好友操作都由聊天服务器完成。

同时由于聊天服务器具有多个，有可能出现两个在不同服务器上的用户的客户端需要通信，比如申请验证好友和收发消息，这时，需要对具体情况进行判断，如下图所示。每一个客户端都有一个uip,根据客户端对应的uip可以查询Redis对应的目的客户端所部署的服务器. 假设客户端1 为源客户端，客户端2为目的客户端，源客户端向目的客户端通信，首先要调用源客户端所在服务器去查询Redis中对应的目的客户端所在的服务器，若如图a所示在同一服务器，则直接通知目的客户端；若如图b所示不在同一服务器上，则通过gRPC通知目的服务器，目的服务器再通知目的客户端。
![用户通信机制](./image/image-2.png)

